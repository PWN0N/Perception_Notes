# Projective Transformation



---

## 一、相机位姿恢复
相机位姿指的是相机坐标系与世界坐标系的关系，也就是变换矩阵$M_{cw}$

---
### （一）旋转的恢复：
根据灭点解出世界坐标系各轴在相机坐标系下的方向


#### 1.简单情况：已知$x,y$轴方向，求$z$轴方向，只需一个灭点——$z$灭点

- $z$灭点：将世界坐标系$z$轴方向上的消影点称为$z$消影点。
    世界坐标：$z_\infty =\left[\begin{matrix}0,0,1,0\\\end{matrix}\right]^T$（最后一维为0代表点在无限远处）
    像素坐标：$v_z=[u,v,1]^T$
- 关系：$$Zv_z=K[r_1,r_2,r_3|t]z_\infty=K[r_3]$$
    - 由外参矩阵只剩下$r_3$推出：相机平移或者绕$z$轴旋转时，相机光轴方向上的消影点在像素坐标系上的位置不变，只有绕$x,y$轴旋转时才会变。
    $$r_3={{K^{-1}v_z}\over {||K^{-1}v_z||}}=\left[\begin{matrix}sin\alpha sin\beta\\cos\beta\\cos\alpha sin\beta\\\end{matrix}\right]$$
    - $\alpha,\beta$是世界坐标系$z$轴在相机坐标系下的方向（pan and tilt angles）
        pan旋转角度，表示相机左右转的程度
        tilt倾斜角度，表示相机上下转的程度

$$\begin{cases}\alpha=tan^{-1}{{r_3(1)}\over {r_3(3)}} \\\beta=cos^{-1}r_3(2)\\\end{cases}$$

#### 2.求三轴方向，需要两个互相垂直方向的灭点

三选二，如选$z$灭点和$x$灭点

- 恢复旋转矩阵$R=[r_1 r_2 r_3]$
    - 用$z$灭点恢复出第三列$r_3$$$r_3=K^{-1}Zv_z$$

    - 用$x$灭点恢复出第一列$r_1$$$r_1=K^{-1}Zv_x$$
    
    - 利用$r_3$$r_1$垂直得到$r_2$$$r_2=r_3\times r_1$$
    
    - 尺度因子$Z$的确定：因为已知$r_1,r_2,r_3$的范数都是1，所以只要调整$Z$使得它们都为单位向量即可，所以$$Z={1\over{||K^{-1}v_{x/y/z}||}}$$
    
### （二） 同时恢复相机的旋转R、平移t和位置C

#### 1.单应性变换，3D平面到2D平面的变换

##### (1)旋转R、平移的t的获得
- 地面上的点$X=\left[\begin{matrix}X\\Y\\ 0\\1\\\end{matrix}\right]$对应平面上的点$m=\left[\begin{matrix}u \\v\\1\\\end{matrix}\right]$

$$Zm=K[r_1 r_2 r_3|t]\left[\begin{matrix}X\\Y\\ 0\\1\\\end{matrix}\right]=K[r_1 r_2 t]\left[\begin{matrix}X\\Y\\ 1\\\end{matrix}\right]$$

$$H'=K[r_1 r_2 t]$$

- 单应矩阵 $H=H'K^{-1}=[r_1 r_2 t]$

- 步骤：选择四个点的世界坐标和图像坐标解出$H'$，在由$K$得到$H$，归一化
    归一化将$H$的三列分别归一化，三列都用第一列的尺度因子（模长）除就行**why？？**
    $r_3=r_1\times r_2$

##### （2）位置C的获得

- $R$和$t$的含义：
    - $R$将世界坐标系旋转到相机坐标系
    - $t$是从光心观察世界原点，是光心指向世界原点的向量（在相机坐标系下）
    $t^{-1}$是从世界原点观察相机，与$t$方向相反（也是在相机坐标系下）

- 相机位置$C$的表示：$$C=-Rt$$
    - $-t$表示相机坐标系下光心的位置，再用$R$将$-t$转换到世界坐标系下
    - $R=R_{cw}$，从相机到世界，它左乘一个向量就把它的坐标值                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        从相机坐标系下转换到世界坐标系下了

    
## 二、四点法计算唯一的投影矩阵

- 投影变换就是任意一个$3\times 3$维的可逆矩阵，表示平面到平面的变换，也叫单应变换

- 投影变换$A$（可逆矩阵，行列式不为零）
    - 点的变换：$p'～Ap$（$\lambda p'=Ap,{\lambda}\ne{0}$)
    - 线的变换：$l'～A^{-T}l$
    *～表示变换是在齐次坐标下定义的*
**证明**：令$x_1$,$x_2$和$x_3$在同一条直线$l$上，因此有$l^Tx_i=0,i=0,...,3$，令$H$为非奇异$3\times3$矩阵，可以证明$l^TH^{-1}Hx_i=0$，因此点$Hx_i$都在$H^{-T}l$上，因而该变换保持共线性
- 特点：关联不变性
    - 共线不变性
    - 并行不变性
- 四点计算唯一的投影矩阵：
    - 黑白格地板正面俯视图和斜视图，规定正面俯视图左下角为原点，向右为$x$向上为 $y$
    - 选四个点：（四组点，两张图中对应为一组，**四点确定三维，opencv中从图像到图像变换，传参为图像坐标，所以三点确定二维即可，所以算出的$H$为$2\times3$维**）
    $a$为$x$方向上的灭点$(1,0,0)$
    $b$为$y$方向上的灭点$(0,1,0)$
    $c$为原点$(0,0,0)$
    $d$为任选的一点，这里选择右上角$(1,1,0)$
    $$\left(\begin{matrix}a, b ,c\\\end{matrix}\right)\left(\begin{matrix}\alpha\\\beta \\\gamma\\\end{matrix}\right)=d$$
    其中$\alpha,\beta,\gamma$为未知量，由四组点解出即得投影变换：$$A=\left(\begin{matrix}\alpha a,\beta b,\gamma c\\\end{matrix}\right)$$

    - 当两平面都没有平行线时，引入辅助规范坐标系，相当于用一个正面俯视图作为桥梁
    $$\begin{cases}a~T(1,0,0)^T\\a'~T'(1,0,0)^T\\\end{cases}$$
    联立得：
    $$a'=T'T^{-1}a=Aa$$

- $H$：投影变换，单应变换，共性变换
    - $H$与灭点的关系：
    第一列$h_1$为左图$x$轴在右图上的方向，即$x$灭点
    第二列$h_2$为左图$y$轴在右图上的方向，即$y$灭点
    第三列$h_3=h_1 \times h_2$为地面法向量，描述地面的倾斜
- $H$包含了两个灭点，也就是包含了地平线信息，由地平线可知相机的位姿以及地面上亮点的实际距离


## 三、单视点测量

### 交比Cross Ratio

-  定义：需要四个点，双比值定义$$CR(A,B,C,D)={AC \over AD} : {BC \over BD} $$
- 性质：**投影变换中，交比$CR(A,B,C,D)$保持不变**$${AC \over AD} : {BC \over BD}  = {AC^{’}\over AD^{’}} : {BC^{’} \over BD^{’} }$$
    
- 应用：**单视角测量**
    - 已知像素距离求真实距离：
    1.D在有限处：十字路口测距，4km牌和2km牌
    2.D为灭点：真实世界CR退化为一个比值$${AC \over BC} = {AC^{’}\over AD^{’}} : {BC^{’} \over BD^{’} }$$
    - 已知真实距离反求图像中灭点位置


### 总结：
1.如果知道一个灭点，就可以计算出这个方向上的任何距离
2.同样可以在平行线中转移距离，前提是我们已知两个灭点（图像取证）
3.在计算的步骤中无需焦距或者其他固有变量，不用知道相机位姿等相机信息**

## 四、双视点测量

- 由两个相机的照片判断球进没进，就是看球在地面上的投影在线内线外，思路：

1. 球$B$在地面上的的垂直投影为$P$，找出$P$在任意一张图上的位置即可
2. 因为$BP$与两条门柱平行，因此$BP$应指向门柱方向的灭点$V$，则在左右图像上分别连接$vb$形成一条垂直线段，$p$应在$vb$直线上
3. 两条垂直线段在地面上的投影交于$P$点，则将它们放到同一张图像上也交于$p$点
4. 左图像上的$vb$经过**投影变换$H$**到右图像上，与右图像上的$v'b'$的交点就是右图像上的$p$，$H$由地面上的小禁区的图像变换得到（why地面not门框面）
（猜测：$VB$线段在左右像平面上的投影可理解为如下：$VB$线段在光心点照射下，可在地平面上的阴影$L'_s$与$L_s$。此时挪开$VB$线段，保留$L'_s$和$L_s$。$L'_s$和$L_s$重新在左右像平面上的投影即为$vb$和$v'b'$），所以，$L'_s$与$L_s$在地平面上的交点即为$P$点，那么，$L'_s$和$L_s$在任意一个像平面上的投影的交点，即为点$P$的投影点$p$。所以$H$的求取需要利用球场上小禁区的白框。使用两幅图小禁区白框的四个点进行计算可得到$H$
如果$H$是点与点之间的单应变换，那么有$$l_s～H^{-T}l$$
那么$P$点的投影$p$是两条线的交点$$p～H^{-T}l\times l'$$
    - 线的变换：
5. 在右图像中比较$p$点跟球门线位置



