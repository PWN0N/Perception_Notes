# Geometry of Image Formation

标签（空格分隔）： vision robotics

---

##相机成像原理

$${1\over f}={1\over a}+{1\over b}$$

$${Y\over a}={y\over b}$$

## 单视角几何
规律：真实世界里的平行线在成像平面上为灭影线，相交于灭点；反之，成像为平行线，真实世界中为以焦距为灭点的灭影线
应用：利用真实世界中的平行线测精确距离

## 双透视绘图仪
两个参数：
**相机高度**（两定点间距），改变**形状**不改变大小，相机越高，椭圆越圆，相机越低，椭圆越椭
**相机焦距**（相当于改变玻璃板的位置），改变**大小**不改变形状，焦距越大，椭圆越大，焦距越小，椭圆越小

## vanishing point
真实世界里地平面上所有方向的线指向的灭点汇聚成地平线
地平线与光心确定的平面永远与成像平面垂直
应用：
1.测身高，过脚底的线与地平线交点找到灭点，从该灭点反射一条过头顶的线，两条线在尺子上的交点间距即位身高，相当于人走到尺子旁边会有多高
2.地平线代表着相机（摄像师）实际高度

---
##齐次坐标法

### homogeneous coordinates齐次坐标
    
- 成像平面上的点坐标为$(x,y,1)$
- 平面上的点都看成原点到该点的一个向量
- 物理世界上的点也在这个向量方向上，只是差一个尺度因子
- 直线满足直线方程$ax+by+cz=0$（其中a,b,c是直线与原点所在平面的法向量），则成像平面上的直线方程为$ax+by+c=0$
-  两点成一线：两点向量做外积求出旋转向量即为直线法向量$l=x*x'$
 两线交点：两线法向量做外积$x=l*l'$
 
- point-line duality对偶性：（点向量和线法向量）点乘点得线，线乘线得点

- 齐次坐标：$[x,y,z]$转换回二维坐标：$[{x\over z},{y\over z}]$

### 理想的点和线

- infinite point：若得到的两线交点齐次坐标为$[x,y,0]$，即代表两线平行，求得的交点即为灭点，$[x,y]$为这组平行线的方向。

    结论：平行线$[a,b,c]$的灭点为$[b,-a,0]$
- infinite line：法向量为$[0,0,1]^T$
因为$\left[\begin{matrix}
0,0,1
\end{matrix}\right]
\left[\begin{matrix}
x\\y\\0\\
\end{matrix}\right]=0$

- 法向量为$[a,b,0]$的直线一定过图像原点（注意法向量确定的是直线与原点所在的平面！不是某条直线！）
    
    
---
##坐标转换

###方法一：平移向量+三个列向量表示旋转矩阵

- A坐标系到B坐标系的转换$P_a=R_{ab}P_b+T_{ab}$
    - $T_{ab}$表示A坐标系原点到B坐标系原点的**平移向量**，在A坐标系下表示
    - $R_{ab}=\left[
\begin{matrix}r_1,r_2,r_3\end{matrix}\right]$表示A坐标系到B坐标系的**旋转矩阵**，由三个列向量组成：
$r_1$表示B坐标系的$x$轴方向在A坐标系下的方向
$r_2$表示B坐标系的$y$轴方向在A坐标系下的方向
$r_3$表示B坐标系的$z$轴方向在A坐标系下的方向
- $M_{ab}$表示A坐标系到B坐标系的**变换矩阵**
    - 定义：将旋转和平移合并到一个矩阵中    $$M_{ab}=
\left[\begin{matrix}
R_{ab},T_{ab}\\
0,0,0,1\\
\end{matrix}\right]$$
    - 好处：便于多个坐标系之间的转换    $M_{ac}=M_{ab}M_{bc}$
- 反变换
    - 旋转矩阵的逆为旋转矩阵的转置（正交矩阵性质）$R_{ba}=R_{ba}^T$
    - 变换矩阵的逆$$M_{ba}=
\left[\begin{matrix}
R_{ab}^T,-R_{ab}^TT_{ab}\\
0,0,0,1\\
\end{matrix}\right]$$
    - 平移向量的逆$T_{ba}=-R_{ab}^TT_{ab}$，*由此可得相机光心的世界坐标为   $P_{w}=T_{wc}=-R_{cw}^TT_{cw}$*

###方法二：n个真正的移动叠加==>n个四维变换矩阵连续右乘

- **三步法**将相机坐标变换到世界坐标系
    - 将光心平移到世界坐标系原点
$$T=
\left[\begin{matrix}
I,T_{cw}\\0,0,0,1\\
\end{matrix}\right]=\left[\begin{matrix}
1,0,0,0\\0,1,0,5\\0,0,1,10\\0,0,0,1\\
\end{matrix}\right]$$
    - 绕$x$轴逆时针转$90^0$将相机坐标系$z$轴与世界坐标系$z$轴对齐
$$R_{x,90}=
\left[\begin{matrix}
1,0,0,0\\0,cos90,-sin90,0\\0,sin90,cos90,0\\0,0,0,1\\
\end{matrix}\right]=\left[\begin{matrix}
1,0,0,0\\0,0,-1,0\\0,1,0,0\\0,0,0,1\\
\end{matrix}\right]$$
    - 绕$z$轴逆时针转$90^0$将相机坐标系$x,y$轴与世界坐标系$x,y$轴对齐
$$R_{z,180}=
\left[\begin{matrix}
cos180,-sin180,0,0\\sin180,cos180,0,0\\0,0,1,0\\0,0,0,1\\
\end{matrix}\right]=\left[\begin{matrix}
-1,0,0,0\\0,-1,0,0\\0,0,1,0\\0,0,0,1\\
\end{matrix}\right]$$
（注意：默认均为右手坐标系）
- Golden Rule：每步变换以当前的坐标轴为准的（即第三步是绕第二步变换之后的$z$轴变换），变换一步就右乘一个变换矩阵（四维）
$$M_{cw}=TR_{x,90}R_{z,180}$$

---

##Pinhole Model

###相机模型的三个参数：
$$\left[\begin{matrix}x\\1\\\end{matrix}\right]=
L{KM\left[\begin{matrix}x\\1\\\end{matrix}\right]}$$

- $L$（**内参**）描述镜头参数
- $K$（**内参**）描述针孔（光心）与传感器的空间关系
- $M$（**外参**）描述机身的运动

针孔模型：在小孔成像模型基础上，将成像平面由针孔后移到针孔前，距离仍为焦距$f$（成像由倒立变为正立）
###投影方程：
$$x'=f{X\over Z}$$
$$y'=f{Y\over Z}$$

- 理解一：除以$Z$是将3D世界收缩到距与相机距离为1的2D平面上，距离越远的点收缩得越厉害；乘$f$是将收缩的2D平面缩放到虚拟成像平面上（与相机距离为$f$且在相机前）
- 理解二：成像平面大小不变，则焦距越大，视野越小。$x',y'$不变，则$f$越大，$X,Y$越小
    
###估测光心位置的方法
    1.标定
    2.利用以光心为灭点的放射线成像为平行线
    创建全景地图时，希望相机的旋转总是以光心为中心的，因此要估计光心位置